<!DOCTYPE html>
<html>
<head>
    <title>Proxy Diagnostics</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a2e; color: #eee; }
        h1 { color: #00ff88; }
        .section { margin: 20px 0; padding: 15px; background: #16213e; border-radius: 8px; }
        .success { color: #00ff88; }
        .error { color: #ff6b6b; }
        .warning { color: #ffd93d; }
        pre { background: #0f0f23; padding: 10px; border-radius: 4px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        td { padding: 8px; border: 1px solid #333; }
        .status-ok { background: #00ff88; color: #000; padding: 2px 8px; border-radius: 4px; }
        .status-error { background: #ff6b6b; color: #000; padding: 2px 8px; border-radius: 4px; }
        .status-pending { background: #ffd93d; color: #000; padding: 2px 8px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üîç Proxy Diagnostics</h1>
    <div id="output">Running tests...</div>
    
    <script>
        const SITE_ID = '3d6c918d-5c39-47e9-8109-be79b2e8c302';
        const API_PROXY = '/api-proxy';
        const DIGITALREACH = 'https://digitalreach.app';
        
        const endpoints = [
            { name: 'Articles List', url: `${API_PROXY}/api/headless/sites-by-id/${SITE_ID}?limit=3&locale=en-US` },
            { name: 'Single Article', url: `${API_PROXY}/api/headless/sites-by-id/${SITE_ID}/articles/sample?locale=en-US` },
            { name: 'Newsletter Subscribe', url: `${API_PROXY}/api/public/sites/${SITE_ID}/newsletter`, method: 'POST', body: { email: 'test@example.com' } },
            { name: 'Sitemap', url: `/sitemap.xml`, check404: true },
            { name: 'Content Images', url: `/api/content/images/${SITE_ID}/test.jpg`, check404: true },
        ];
        
        async function testEndpoint(ep, index) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${ep.name}</td>
                <td><pre>${ep.url}</pre></td>
                <td id="status-${index}" class="status-pending">Testing...</td>
            `;
            return row;
        }
        
        async function runTests() {
            const output = document.getElementById('output');
            let html = '<div class="section"><h2>Environment</h2>';
            html += `<p>Site ID: ${SITE_ID}</p>`;
            html += `<p>API Proxy: ${API_PROXY}</p>`;
            html += `<p>DigitalReach: ${DIGITALREACH}</p>`;
            html += '</div>';
            
            html += '<div class="section"><h2>Proxy Routes</h2>';
            html += '<table><tr><th>Endpoint</th><th>URL</th><th>Status</th></tr>';
            
            for (let i = 0; i < endpoints.length; i++) {
                const ep = endpoints[i];
                const row = await testEndpoint(ep, i);
                html += row.outerHTML;
                
                // Test async
                setTimeout(async () => {
                    const td = document.getElementById(`status-${i}`);
                    try {
                        let response;
                        if (ep.method === 'POST') {
                            response = await fetch(ep.url, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(ep.body)
                            });
                        } else {
                            response = await fetch(ep.url);
                        }
                        
                        if (response.ok) {
                            td.innerHTML = '<span class="status-ok">‚úÖ OK (' + response.status + ')</span>';
                            const text = await response.text();
                            console.log(`${ep.name}:`, text.substring(0, 200));
                        } else if (ep.check404 && response.status === 404) {
                            td.innerHTML = '<span class="status-ok">‚úÖ 404 (proxy working)</span>';
                        } else {
                            td.innerHTML = '<span class="status-error">‚ùå ' + response.status + '</span>';
                        }
                    } catch (error) {
                        td.innerHTML = '<span class="status-error">‚ùå ' + error.message + '</span>';
                    }
                }, i * 500);
            }
            
            html += '</table></div>';
            output.innerHTML = html;
        }
        
        runTests();
    </script>
</body>
</html>
